<div class="shell">
  <!-- animated gradient background -->
  <div class="bg fx-blob-1"></div>
  <div class="bg fx-blob-2"></div>
  <div class="bg fx-blob-3"></div>

  <div class="container fade-in">
    <header class="topbar card slide-up">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#8E2DE2"/>
                <stop offset="100%" stop-color="#4A00E0"/>
              </linearGradient>
            </defs>
            <path fill="url(#g1)"
              d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 14.93A7.014 7.014 0 0 1 5.07 11H7a5 5 0 0 0 6 4.9Zm5.93-5.93A7.014 7.014 0 0 1 13 18.93V17a5 5 0 0 0 4.93-6Z"/>
          </svg>
        </div>
        <h1 class="title">{{ title }}</h1>
      </div>

      <div class="actions">
        <button class="btn ghost" (click)="clear()" title="Clear chat">Clear chat</button>
      </div>
    </header>

    <!-- Upload / Dropzone -->
    <section class="upload card slide-up delay-1">
      <div class="drop"
           (drop)="onDrop($event)"
           (dragover)="onDragOver($event)">
        <div class="drop-inner">
          <div class="drop-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 16v-6m0 0l-3 3m3-3l3 3M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/>
              <path d="M16 13V8a4 4 0 1 0-8 0v5"/>
            </svg>
          </div>
          <p class="drop-text">
            <strong>Drop PDF / DOCX / TXT here</strong>
            <span>or</span>
          </p>

          <label class="btn primary file-btn">
            Select files
            <input type="file"
                   multiple
                   (change)="onPick($event)"
                   accept=".pdf,.docx,.txt" />
          </label>

          <div class="progress" *ngIf="uploading()">Uploading &amp; processingâ€¦</div>
        </div>
      </div>
    </section>

    <!-- Docs list -->
    <section class="docs card slide-up delay-2" *ngIf="docs().length">
      <div class="section-head">
        <h2>Uploaded Notes ({{ docs().length }})</h2>
      </div>

      <ul class="doc-grid">
        <li class="doc-item" *ngFor="let d of docs()">
          <label class="doc-row">
            <input type="checkbox"
                   [checked]="selected().has(d.id)"
                   (change)="toggleDoc(d.id)" />
            
            <!-- File Type Icon -->
            <div class="file-icon" [attr.data-type]="getFileType(d.name)">
              <!-- PDF Icon -->
              <svg *ngIf="getFileType(d.name) === 'pdf'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <text x="7" y="18" font-size="6" font-weight="bold" fill="currentColor">PDF</text>
              </svg>
              
              <!-- DOCX Icon -->
              <svg *ngIf="getFileType(d.name) === 'docx'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="8" y1="13" x2="16" y2="13"/>
                <line x1="8" y1="17" x2="16" y2="17"/>
              </svg>
              
              <!-- TXT Icon -->
              <svg *ngIf="getFileType(d.name) === 'txt'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="8" y1="13" x2="16" y2="13"/>
                <line x1="8" y1="17" x2="12" y2="17"/>
              </svg>
              
              <!-- Unknown/Default Icon -->
              <svg *ngIf="getFileType(d.name) === 'unknown'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </div>

            <div class="doc-meta">
              <div class="doc-name" [title]="d.name">{{ d.name }}</div>
              <div class="doc-sub">{{ d.chunkCount }} chunks</div>
            </div>
          </label>
          
          <div class="doc-actions">
            <button class="btn soft" (click)="doSummarize(d)" title="Summarize document">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <line x1="10" y1="9" x2="8" y2="9"/>
              </svg>
            </button>
            
            <button class="btn danger-outline" (click)="deleteDoc(d.id, d.name)" title="Delete document">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>
          </div>
        </li>
      </ul>
    </section>

    <!-- Ask -->
    <section class="ask card slide-up delay-3">
      <div class="section-head">
        <h2>Ask your notes</h2>
        <p class="hint">Tip: select specific docs above to narrow context. K = how many chunks to retrieve.</p>
      </div>

      <div class="controls">
        <div class="input-wrap">
          <input [(ngModel)]="question"
                 class="input"
                 placeholder="e.g., What are the 3 key steps of cellular respiration?" />
        </div>

        <label class="k-wrap" title="Top-K chunks to include in the answer">
          <span>K</span>
          <input type="number" [(ngModel)]="k" min="3" max="12" class="input k-input">
        </label>

        <button class="btn primary lg" (click)="ask()">
          <span>Ask</span>
        </button>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat card slide-up delay-4" *ngIf="chat().length">
      <div class="section-head">
        <h2>Chat</h2>
      </div>

      <div class="bubble-wrap">
        <div class="bubble" *ngFor="let m of chat()"
             [class.me]="m.role==='user'"
             [class.ai]="m.role==='assistant'">
          <div class="bubble-inner">
            <pre>{{ m.content }}</pre>
            <div class="cites" *ngIf="m.citations?.length">
              <span *ngFor="let c of m.citations" class="cite-pill">
                [{{c.label}} {{c.name}}#{{c.chunkId}}]
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <section class="summary card slide-up delay-5" *ngIf="summary()">
      <div class="section-head">
        <h2>Summary</h2>
      </div>
      <div class="summary-box">
        <pre>{{ summary() }}</pre>
      </div>
    </section>

    <!-- Error -->
    <section class="toast error slide-up delay-5" *ngIf="error()">
      <div class="toast-inner">
        <strong>Error:</strong> {{ error() }}
      </div>
    </section>

    <!-- ðŸ“˜ Flashcards Section -->
    <section class="flashcards card slide-up delay-6">
      <div class="section-head">
        <h2>Smart Flashcards</h2>
      </div>

      <p>Generate study flashcards from any uploaded document.</p>

      <!-- Document selector -->
      <label>
        Document:
        <select [ngModel]="selectedFlashcardDocId()" (ngModelChange)="selectedFlashcardDocId.set($event)">
          <option [ngValue]="null">-- choose a document --</option>
          <option *ngFor="let d of docs()" [ngValue]="d.id">
            {{ d.name }}
          </option>
        </select>
      </label>

      <!-- Number of cards -->
      <label style="margin-left: 1rem;">
        Cards:
        <input
          type="number"
          min="3"
          max="20"
          [ngModel]="flashcardCount()"
          (ngModelChange)="flashcardCount.set($event)"
          style="width: 4rem;"
        />
      </label>

      <!-- Generate button -->
      <button
        class="btn primary lg"
        (click)="generateFlashcards()"
        [disabled]="isLoadingFlashcards()"
        style="margin-left: 1rem;"
      >
        {{ isLoadingFlashcards() ? 'Generatingâ€¦' : 'Generate Flashcards' }}
      </button>

      <!-- Export flashcards to Anki -->
      <button
        class="btn primary lg"
        (click)="generateFlashcards()"
        [disabled]="isLoadingFlashcards()"
        style="margin-left: 1rem;"
      >
        {{ isLoadingFlashcards() ? 'Generatingâ€¦' : 'Generate Flashcards' }}
      </button>

      <button
        class="btn"
        (click)="exportFlashcardsToAnki()"
        [disabled]="!flashcards().length"
        style="margin-left: 0.5rem;"
      >
        Export to Anki (.tsv)
      </button>

      <!-- Error -->
      <p *ngIf="flashcardError()" style="color:red; margin-top:0.5rem;">
        {{ flashcardError() }}
      </p>

      <!-- Flashcard Grid -->
      <div
        *ngIf="flashcards().length"
        style="
          margin-top:1rem;
          display:grid;
          grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
          gap:1rem;
        "
      >
        <div
          *ngFor="let fc of flashcards(); let i = index"
          (click)="toggleFlashcard(i)"
          style="
            border:1px solid #ddd;
            border-radius:10px;
            padding:1rem;
            cursor:pointer;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
            background:white;
          "
        >
          <div *ngIf="!fc.show">
            <strong>Q:</strong> {{ fc.question }}
            <p style="opacity:0.6; margin-top:0.5rem;">Click to reveal answer</p>
          </div>

          <div *ngIf="fc.show">
            <strong>A:</strong> {{ fc.answer }}
            <p style="opacity:0.6; margin-top:0.5rem;">Click to hide answer</p>
          </div>
        </div>
      </div>
    </section>
    <!-- END Flashcards Section -->

    <!-- ðŸ“ Quiz Section -->
    <section class="quiz card slide-up delay-7">
      <div class="section-head">
        <h2>Multiple Choice Quiz</h2>
      </div>

      <p>Generate a 3-question multiple choice quiz from any uploaded document.</p>

      <!-- Document selector -->
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
        <label>
          Document:
          <select [ngModel]="selectedQuizDocId()" (ngModelChange)="selectedQuizDocId.set($event)">
            <option [ngValue]="null">-- choose a document --</option>
            <option *ngFor="let d of docs()" [ngValue]="d.id">
              {{ d.name }}
            </option>
          </select>
        </label>

        <!-- Generate button -->
        <button
          class="btn primary lg"
          (click)="generateQuiz()"
          [disabled]="isLoadingQuiz()"
        >
          {{ isLoadingQuiz() ? 'Generatingâ€¦' : 'Generate Quiz' }}
        </button>

        <!-- Reset button (shown after quiz is generated) -->
        <button
          *ngIf="quizQuestions().length"
          class="btn ghost"
          (click)="resetQuiz()"
        >
          Reset Quiz
        </button>
      </div>

      <!-- Error -->
      <p *ngIf="quizError()" style="color:red; margin-top:0.5rem;">
        {{ quizError() }}
      </p>

      <!-- Quiz Questions -->
      <div *ngIf="quizQuestions().length" style="margin-top: 2rem;">
        <div *ngFor="let q of quizQuestions(); let qIndex = index" 
              style="
                margin-bottom: 2rem;
                padding: 1.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 12px;
                background: white;
              ">
          
          <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">
            Question {{ qIndex + 1 }}: {{ q.question }}
          </h3>

          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <label 
              *ngFor="let option of q.options; let oIndex = index"
              style="
                display: flex;
                align-items: center;
                padding: 0.75rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
              "
              [style.border-color]="q.selectedIndex === oIndex ? '#8E2DE2' : '#e0e0e0'"
              [style.background-color]="
                q.answered 
                  ? (oIndex === q.correctIndex ? '#d4edda' : (q.selectedIndex === oIndex && oIndex !== q.correctIndex ? '#f8d7da' : 'white'))
                  : (q.selectedIndex === oIndex ? '#f3e5f5' : 'white')
              "
              (click)="selectQuizAnswer(qIndex, oIndex)"
            >
              <input 
                type="radio" 
                [name]="'question-' + qIndex"
                [checked]="q.selectedIndex === oIndex"
                [disabled]="quizSubmitted()"
                style="margin-right: 0.75rem;"
              />
              <span>{{ option }}</span>
              
              <!-- Show correct/incorrect indicators after submission -->
              <span 
                *ngIf="q.answered && oIndex === q.correctIndex"
                style="margin-left: auto; color: #155724; font-weight: bold;"
              >
                âœ“ Correct
              </span>
              <span 
                *ngIf="q.answered && q.selectedIndex === oIndex && oIndex !== q.correctIndex"
                style="margin-left: auto; color: #721c24; font-weight: bold;"
              >
                âœ— Incorrect
              </span>
            </label>
          </div>
        </div>

        <!-- Submit button -->
        <div style="margin-top: 1.5rem; display: flex; align-items: center; gap: 1rem;">
          <button
            *ngIf="!quizSubmitted()"
            class="btn primary lg"
            (click)="submitQuiz()"
          >
            Submit Quiz
          </button>

          <!-- Score display -->
          <div 
            *ngIf="quizSubmitted()" 
            style="
              padding: 1rem 1.5rem;
              background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%);
              color: white;
              border-radius: 8px;
              font-size: 1.1rem;
              font-weight: bold;
            "
          >
            Your Score: {{ getQuizScore().correct }} / {{ getQuizScore().total }}
            ({{ (getQuizScore().correct / getQuizScore().total * 100).toFixed(0) }}%)
          </div>
        </div>
      </div>
    </section>
    <!-- END Quiz Section -->
    
    <!-- ðŸ“š Glossary Builder Section (NEW) -->
    <section class="glossary card slide-up delay-8">
      <div class="section-head">
        <h2>Key Concept/Glossary Builder</h2>
      </div>

      <p>Automatically extract key terms and definitions from the selected document.</p>
      
      <!-- Document selector -->
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
        <label>
          Document:
          <select [ngModel]="selectedGlossaryDocId()" (ngModelChange)="selectedGlossaryDocId.set($event)">
            <option [ngValue]="null">-- choose a document --</option>
            <option *ngFor="let d of docs()" [ngValue]="d.id">
              {{ d.name }}
            </option>
          </select>
        </label>

        <!-- Generate button -->
        <button
          class="btn primary lg"
          (click)="generateGlossary()"
          [disabled]="isLoadingGlossary()"
        >
          {{ isLoadingGlossary() ? 'Extractingâ€¦' : 'Build Glossary' }}
        </button>
      </div>
      
      <!-- Error -->
      <p *ngIf="glossaryError()" style="color:red; margin-top:0.5rem;">
        {{ glossaryError() }}
      </p>

      <!-- Glossary Output -->
      <div *ngIf="glossary().length" style="margin-top: 1.5rem; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
        <h4 style="margin-top: 0; margin-bottom: 1rem;">Extracted Terms ({{ glossary().length }})</h4>
        <div *ngFor="let term of glossary()" style="margin-bottom: 0.75rem;">
          <strong style="color: #4A00E0;">{{ term.term }}:</strong> {{ term.definition }}
        </div>
      </div>
    </section>
    <!-- END Glossary Builder Section -->

    <!-- ðŸ—“ï¸ Learning Plan Generator Section (NEW) -->
    <section class="learning-plan card slide-up delay-9">
      <div class="section-head">
        <h2>Learning Plan Generator</h2>
      </div>

      <p>Generate a structured learning path to master the content of the selected document.</p>
      
      <!-- Document selector -->
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
        <label>
          Document:
          <select [ngModel]="selectedPlanDocId()" (ngModelChange)="selectedPlanDocId.set($event)">
            <option [ngValue]="null">-- choose a document --</option>
            <option *ngFor="let d of docs()" [ngValue]="d.id">
              {{ d.name }}
            </option>
          </select>
        </label>

        <!-- Generate button -->
        <button
          class="btn primary lg"
          (click)="generateLearningPlan()"
          [disabled]="isLoadingPlan()"
        >
          {{ isLoadingPlan() ? 'Planningâ€¦' : 'Generate Learning Plan' }}
        </button>
      </div>
      
      <!-- Error -->
      <p *ngIf="planError()" style="color:red; margin-top:0.5rem;">
        {{ planError() }}
      </p>

      <!-- Learning Plan Output -->
      <div *ngIf="learningPlan()" style="margin-top: 1.5rem; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
        <h3 style="margin-top: 0;">{{ learningPlan()!.planTitle }}</h3>
        <ol style="margin-left: 1rem; padding-left: 0;">
          <li *ngFor="let step of learningPlan()!.steps" style="margin-bottom: 1rem;">
            <strong>Step {{ step.stepNumber }}: {{ step.title }} ({{ step.expectedTime }})</strong>
            <p style="margin-top: 0.2rem; margin-bottom: 0;">{{ step.description }}</p>
          </li>
        </ol>
      </div>
    </section>
    <!-- END Learning Plan Generator Section -->

    <footer class="foot fade-in delay-6">
      <span>ScholarAI â€“ local demo (text-only store, embeddings on-demand)</span>
    </footer>
  </div>
</div>